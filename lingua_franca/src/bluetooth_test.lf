target C {
    platform: {
      name: "rp2040",
      board: "pololu_3pi_2040_robot"
    },
    single-threaded: true
}

import Display from "lib/Display.lf"

preamble {=
    #include <stdio.h>
    #include <pico/stdlib.h>
    #include <hardware/gpio.h>
=}

reactor RobotBLE {

    timer check_uart(0 ms, 10 ms)
    output rx_char: char
    input tx_char: char

    reaction(startup) {=
        stdio_init_all();

        uart_init(uart0, 9600);
        gpio_set_function(28, GPIO_FUNC_UART);
        gpio_set_function(29, GPIO_FUNC_UART);
    =}

    reaction(check_uart) -> rx_char {=
        if (uart_is_readable(uart0)) {
            char c = uart_getc(uart0);
            printf("Reading: %c\n", c);

            if (c != '0') {
                printf("HEY, %c", c);
                lf_set(rx_char, c);
            }
        }
    =}

    reaction(tx_char) {=
        uart_puts(uart0, "ECHO: ");
        uart_putc(uart0, tx_char->value);
        uart_puts(uart0, "\n");
    =}
}

main reactor bluetooth_test {
    ble = new RobotBLE()
    disp = new Display()

    timer t(0, 1 s)
    reaction(ble.rx_char) -> disp.line0 {=
        static char buf[17];
        snprintf(buf, 17, "Read: %c", ble.rx_char->value);
        lf_set(disp.line0, buf);
    =}
    reaction(t) -> ble.tx_char {=
        lf_set(ble.tx_char, 'H');    
    =}
}
